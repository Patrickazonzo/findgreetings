<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enigma 1 - Cifrario</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
  <link rel="stylesheet" href="assets/style.css?v=2025-09-24-01">
  <script src="assets/app.js?v=2025-09-24-01"></script>
</head>
<body data-page="enigma1">
  <script>initGate('enigma1', { requiredStep: 'start' });</script>
  <main class="container-narrow">
    <article class="center-stack">
      <header>
        <h1>Enigma 1 - Cifrario mutevole</h1>
      </header>

      <section class="cipher-board">
        <pre id="cipherText" class="cipher-text">?</pre>
      </section>

      <form id="cipherForm" class="cipher-form">
        <label for="cipherAnswer">Ricostruisci il testo originale</label>
        <input id="cipherAnswer" name="answer" type="text" autocomplete="off" spellcheck="false" placeholder="Scrivi la frase" required>
        <button type="submit">Conferma</button>
        <p id="cipherFeedback" class="cipher-feedback" aria-live="polite"></p>
      </form>

    </article>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const TARGET = 'LANTERNA SUL BALCONE';
      const targetNormalized = TARGET.replace(/[^a-z]/gi, '').toLowerCase();

      const cipherTextEl = document.getElementById('cipherText');
      const form = document.getElementById('cipherForm');
      const answerInput = document.getElementById('cipherAnswer');
      const feedbackEl = document.getElementById('cipherFeedback');

      if (!cipherTextEl || !form || !answerInput || !feedbackEl) return;

      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

      const normalize = (text) => (text || '').replace(/[^a-z]/gi, '').toLowerCase();

      const encode = (plain, shift) => {
        const upper = plain.toUpperCase();
        return Array.from(upper).map((char) => {
          const idx = alphabet.indexOf(char);
          if (idx === -1) return char;
          const newIdx = (idx + shift + 26) % 26;
          return alphabet[newIdx];
        }).join('');
      };

      const randomShift = () => {
        let shift = 0;
        while (shift === 0) {
          shift = Math.floor(Math.random() * 25) + 1; // 1..25
          if (Math.random() < 0.5) shift *= -1;
        }
        return shift;
      };

      const rollCipher = (reason = 'auto') => {
        const encoded = encode(targetNormalized, randomShift()).match(/.{1,4}/g)?.join(' ') || '';
        cipherTextEl.textContent = encoded;
        if (reason === 'typing') {
          cipherTextEl.classList.add('wiggle');
          setTimeout(() => cipherTextEl.classList.remove('wiggle'), 180);
        }
      };

      const handleSubmit = (event) => {
        event.preventDefault();
        const attempt = normalize(answerInput.value);
        if (!attempt) {
          feedbackEl.textContent = 'Serve scrivere qualcosa.';
          feedbackEl.dataset.state = 'warn';
          return;
        }
        if (attempt === targetNormalized) {
          feedbackEl.textContent = 'Perfetto! Avanti cosi.';
          feedbackEl.dataset.state = 'ok';
          setTimeout(() => goNext('enigma2.html', 'enigma2'), 400);
          return;
        }
        feedbackEl.textContent = 'Nope. Il cifrario si confonde e cambia di nuovo.';
        feedbackEl.dataset.state = 'error';
        answerInput.focus();
        rollCipher('manual');
      };

      form.addEventListener('submit', handleSubmit);
      answerInput.addEventListener('input', () => rollCipher('typing'));

      rollCipher('init');
    });
  </script>
</body>
</html>
