<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finale</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
  <link rel="stylesheet" href="assets/style.css?v=2025-09-24-01">
  <style>
    .eye-btn {
      position: fixed;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 1.4em;
      height: 1.4em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0.16;
      transition: opacity .25s ease, transform .15s ease;
      z-index: 9999;
      clip-path: circle(45%);
    }

    .eye-btn:hover,
    .eye-btn:focus-visible {
      opacity: 0.82;
      transform: scale(1.22);
      outline: none;
    }
  </style>
  <script src="assets/app.js?v=2025-09-24-01"></script>
</head>
<body data-page="final">
  <script>initGate('final', { requiredStep: 'enigma5' });</script>
  <main class="container-narrow center-stack">
    <h1>Congratulazioni.</h1>
    <p>Hai terminato il percorso: trova l'occhio corretto e ascolta il messaggio.</p>
  </main>

  <dialog id="auguriDialog">
    <article>
      <header><h2>Un pensiero finale</h2></header>
      <p><strong>Buon compleanno, Alessio!</strong><br> Anche stavolta vinci te.</p>
      <footer><button type="button" data-role="close-auguri">Chiudi</button></footer>
    </article>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const TOTAL_EYES = 12;
      const MIN_DIST = 34;
      const VIEWPORT_PADDING = 48;
      const dialog = document.getElementById('auguriDialog');
      const closeBtn = dialog?.querySelector('[data-role="close-auguri"]');

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
      const rand = (min, max) => Math.random() * (max - min) + min;

      const clearEyes = () => {
        document.querySelectorAll('.eye-btn').forEach((node) => node.remove());
      };

      const spawnEyes = () => {
        clearEyes();
        const winnerIndex = Math.floor(Math.random() * TOTAL_EYES);
        const placed = [];

        for (let i = 0; i < TOTAL_EYES; i += 1) {
          const btn = document.createElement('button');
          btn.className = 'eye-btn';
          btn.type = 'button';
          btn.textContent = String.fromCodePoint(0x1F441);

          let attempts = 0;
          let x = 0;
          let y = 0;
          const maxWidth = Math.max(VIEWPORT_PADDING, window.innerWidth - VIEWPORT_PADDING);
          const maxHeight = Math.max(VIEWPORT_PADDING, window.innerHeight - VIEWPORT_PADDING);
          do {
            x = clamp(rand(VIEWPORT_PADDING, maxWidth), VIEWPORT_PADDING, maxWidth);
            y = clamp(rand(VIEWPORT_PADDING, maxHeight), VIEWPORT_PADDING, maxHeight);
            attempts += 1;
          } while (attempts < 40 && placed.some((p) => Math.hypot(p.x - x, p.y - y) < MIN_DIST));

          btn.style.left = `${x}px`;
          btn.style.top = `${y}px`;
          placed.push({ x, y });

          if (i === winnerIndex) {
            btn.addEventListener('click', () => {
              clearEyes();
              if (typeof showAuguri === 'function') {
                showAuguri();
              }
            }, { once: true });
          } else {
            btn.addEventListener('click', () => {
              spawnEyes();
            });
          }

          document.body.appendChild(btn);
        }
      };

      closeBtn?.addEventListener('click', () => dialog?.close());

      spawnEyes();

      let resizeTimer = null;
      window.addEventListener('resize', () => {
        if (resizeTimer) {
          window.cancelAnimationFrame(resizeTimer);
        }
        resizeTimer = window.requestAnimationFrame(() => {
          spawnEyes();
        });
      });
    });
  </script>
</body>
</html>
