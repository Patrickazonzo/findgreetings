<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finale (?)</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
  <link rel="stylesheet" href="assets/style.css?v=2025-09-24-01">
  <style>
    .eye-btn {
      position: fixed;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 1.4em;
      height: 1.4em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0.14;
      transition: opacity .25s ease, transform .15s ease;
      z-index: 9999;
      clip-path: circle(45%);
    }

    .eye-btn:hover {
      opacity: .78;
      transform: scale(1.22);
    }

    canvas.confetti-canvas {
      position: fixed !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      pointer-events: none;
      z-index: 13000 !important;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .55);
      z-index: 12000;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="assets/app.js?v=2025-09-24-01"></script>
</head>
<body data-page="final">
  <script>initGate('final', { requiredStep: 'enigma5' });</script>
  <main class="container-narrow center-stack">
    <h1>Congratulazioni... forse.</h1>
    <p>Hai completato gli enigmi. Ora devi scegliere quale occhio sa davvero dove guardare.</p>
  </main>

  <dialog id="auguriDialog">
    <article>
      <header><h2>Ok, ci ho provato...</h2></header>
      <p><strong>Buon compleanno, Alessio!</strong><br> Anche stavolta vinci te.</p>
      <footer><button type="button" data-role="close-auguri">Chiudi</button></footer>
    </article>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const TOTAL_EYES = 12;
      // TODO: Implementare contatore tentativi (max 3 errori) e feedback visivo/testuale
      const MIN_DIST = 34;
      const VIEWPORT_PADDING = 48;
      const auguriDialog = document.getElementById('auguriDialog');
      const closeBtn = auguriDialog?.querySelector('[data-role="close-auguri"]');

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
      const rand = (min, max) => Math.random() * (max - min) + min;

      const ensureCanvasClass = () => {
        const canvases = document.querySelectorAll('canvas');
        canvases.forEach((canvas) => canvas.classList.add('confetti-canvas'));
      };

      const patchConfetti = () => {
        if (typeof window.confetti !== 'function') return;
        const original = window.confetti;
        window.confetti = function () {
          const result = original.apply(this, arguments);
          setTimeout(ensureCanvasClass, 0);
          setTimeout(ensureCanvasClass, 200);
          return result;
        };
      };

      const spawnEyes = () => {
        const winnerIndex = Math.floor(Math.random() * TOTAL_EYES);
        const placed = [];
        for (let i = 0; i < TOTAL_EYES; i += 1) {
          const btn = document.createElement('button');
          btn.className = 'eye-btn';
          btn.type = 'button';
          btn.textContent = String.fromCodePoint(0x1F441);

          let attempts = 0;
          let x = 0;
          let y = 0;
          const maxWidth = Math.max(VIEWPORT_PADDING, window.innerWidth - VIEWPORT_PADDING);
          const maxHeight = Math.max(VIEWPORT_PADDING, window.innerHeight - VIEWPORT_PADDING);
          do {
            x = clamp(rand(VIEWPORT_PADDING, maxWidth), VIEWPORT_PADDING, maxWidth);
            y = clamp(rand(VIEWPORT_PADDING, maxHeight), VIEWPORT_PADDING, maxHeight);
            attempts += 1;
          } while (attempts < 40 && placed.some((p) => Math.hypot(p.x - x, p.y - y) < MIN_DIST));

          btn.style.left = x + 'px';
          btn.style.top = y + 'px';
          placed.push({ x, y });

          if (i === winnerIndex) {
            btn.addEventListener('click', () => {
              if (typeof showAuguri === 'function') {
                showAuguri();
                ensureCanvasClass();
              }
            });
          } else {
            btn.addEventListener('click', () => resetToStart()); // TODO: Integrare decremento tentativi e gestione fallimenti
          }
          document.body.appendChild(btn);
        }
      };

      const resetEyes = () => {
        document.querySelectorAll('.eye-btn').forEach((node) => node.remove());
        spawnEyes();
      };

      closeBtn?.addEventListener('click', () => auguriDialog?.close());

      patchConfetti();
      spawnEyes();
      window.addEventListener('resize', () => {
        window.requestAnimationFrame(() => resetEyes());
      });
    });
  </script>
</body>
</html>
